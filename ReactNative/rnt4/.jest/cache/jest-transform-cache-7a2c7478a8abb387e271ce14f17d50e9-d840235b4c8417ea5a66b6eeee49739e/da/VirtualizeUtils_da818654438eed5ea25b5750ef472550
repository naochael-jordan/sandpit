99e548229b253555cecebbd92c7d01e3

'use strict';

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[typeof Symbol === 'function' ? Symbol.iterator : '@@iterator'](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if ((typeof Symbol === 'function' ? Symbol.iterator : '@@iterator') in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var invariant = require('fbjs/lib/invariant');

function elementsThatOverlapOffsets(offsets, itemCount, getFrameMetrics) {
  var out = [];
  var outLength = 0;
  for (var ii = 0; ii < itemCount; ii++) {
    var frame = getFrameMetrics(ii);
    var trailingOffset = frame.offset + frame.length;
    for (var kk = 0; kk < offsets.length; kk++) {
      if (out[kk] == null && trailingOffset >= offsets[kk]) {
        out[kk] = ii;
        outLength++;
        if (kk === offsets.length - 1) {
          invariant(outLength === offsets.length, 'bad offsets input, should be in increasing order: %s', JSON.stringify(offsets));
          return out;
        }
      }
    }
  }
  return out;
}

function newRangeCount(prev, next) {
  return next.last - next.first + 1 - Math.max(0, 1 + Math.min(next.last, prev.last) - Math.max(next.first, prev.first));
}

function computeWindowedRenderLimits(props, prev, getFrameMetricsApprox, scrollMetrics) {
  var data = props.data,
      getItemCount = props.getItemCount,
      maxToRenderPerBatch = props.maxToRenderPerBatch,
      windowSize = props.windowSize;

  var itemCount = getItemCount(data);
  if (itemCount === 0) {
    return prev;
  }
  var offset = scrollMetrics.offset,
      velocity = scrollMetrics.velocity,
      visibleLength = scrollMetrics.visibleLength;

  var visibleBegin = Math.max(0, offset);
  var visibleEnd = visibleBegin + visibleLength;
  var overscanLength = (windowSize - 1) * visibleLength;

  var leadFactor = 0.5;

  var fillPreference = velocity > 1 ? 'after' : velocity < -1 ? 'before' : 'none';

  var overscanBegin = Math.max(0, visibleBegin - (1 - leadFactor) * overscanLength);
  var overscanEnd = Math.max(0, visibleEnd + leadFactor * overscanLength);

  var lastItemOffset = getFrameMetricsApprox(itemCount - 1).offset;
  if (lastItemOffset < overscanBegin) {
    return {
      first: Math.max(0, itemCount - 1 - maxToRenderPerBatch),
      last: itemCount - 1
    };
  }

  var _elementsThatOverlapO = elementsThatOverlapOffsets([overscanBegin, visibleBegin, visibleEnd, overscanEnd], props.getItemCount(props.data), getFrameMetricsApprox),
      _elementsThatOverlapO2 = _slicedToArray(_elementsThatOverlapO, 4),
      overscanFirst = _elementsThatOverlapO2[0],
      first = _elementsThatOverlapO2[1],
      last = _elementsThatOverlapO2[2],
      overscanLast = _elementsThatOverlapO2[3];

  overscanFirst = overscanFirst == null ? 0 : overscanFirst;
  first = first == null ? Math.max(0, overscanFirst) : first;
  overscanLast = overscanLast == null ? itemCount - 1 : overscanLast;
  last = last == null ? Math.min(overscanLast, first + maxToRenderPerBatch - 1) : last;
  var visible = { first: first, last: last };

  var newCellCount = newRangeCount(prev, visible);

  while (true) {
    if (first <= overscanFirst && last >= overscanLast) {
      break;
    }
    var maxNewCells = newCellCount >= maxToRenderPerBatch;
    var firstWillAddMore = first <= prev.first || first > prev.last;
    var firstShouldIncrement = first > overscanFirst && (!maxNewCells || !firstWillAddMore);
    var lastWillAddMore = last >= prev.last || last < prev.first;
    var lastShouldIncrement = last < overscanLast && (!maxNewCells || !lastWillAddMore);
    if (maxNewCells && !firstShouldIncrement && !lastShouldIncrement) {
      break;
    }
    if (firstShouldIncrement && !(fillPreference === 'after' && lastShouldIncrement && lastWillAddMore)) {
      if (firstWillAddMore) {
        newCellCount++;
      }
      first--;
    }
    if (lastShouldIncrement && !(fillPreference === 'before' && firstShouldIncrement && firstWillAddMore)) {
      if (lastWillAddMore) {
        newCellCount++;
      }
      last++;
    }
  }
  if (!(last >= first && first >= 0 && last < itemCount && first >= overscanFirst && last <= overscanLast && first <= visible.first && last >= visible.last)) {
    throw new Error('Bad window calculation ' + JSON.stringify({
      first: first,
      last: last,
      itemCount: itemCount,
      overscanFirst: overscanFirst,
      overscanLast: overscanLast,
      visible: visible
    }));
  }
  return { first: first, last: last };
}

var VirtualizeUtils = {
  computeWindowedRenderLimits: computeWindowedRenderLimits,
  elementsThatOverlapOffsets: elementsThatOverlapOffsets,
  newRangeCount: newRangeCount
};

module.exports = VirtualizeUtils;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlZpcnR1YWxpemVVdGlscy5qcyJdLCJuYW1lcyI6WyJpbnZhcmlhbnQiLCJyZXF1aXJlIiwiZWxlbWVudHNUaGF0T3ZlcmxhcE9mZnNldHMiLCJvZmZzZXRzIiwiaXRlbUNvdW50IiwiZ2V0RnJhbWVNZXRyaWNzIiwib3V0Iiwib3V0TGVuZ3RoIiwiaWkiLCJmcmFtZSIsInRyYWlsaW5nT2Zmc2V0Iiwib2Zmc2V0IiwibGVuZ3RoIiwia2siLCJKU09OIiwic3RyaW5naWZ5IiwibmV3UmFuZ2VDb3VudCIsInByZXYiLCJuZXh0IiwibGFzdCIsImZpcnN0IiwiTWF0aCIsIm1heCIsIm1pbiIsImNvbXB1dGVXaW5kb3dlZFJlbmRlckxpbWl0cyIsInByb3BzIiwiZ2V0RnJhbWVNZXRyaWNzQXBwcm94Iiwic2Nyb2xsTWV0cmljcyIsImRhdGEiLCJnZXRJdGVtQ291bnQiLCJtYXhUb1JlbmRlclBlckJhdGNoIiwid2luZG93U2l6ZSIsInZlbG9jaXR5IiwidmlzaWJsZUxlbmd0aCIsInZpc2libGVCZWdpbiIsInZpc2libGVFbmQiLCJvdmVyc2Nhbkxlbmd0aCIsImxlYWRGYWN0b3IiLCJmaWxsUHJlZmVyZW5jZSIsIm92ZXJzY2FuQmVnaW4iLCJvdmVyc2NhbkVuZCIsImxhc3RJdGVtT2Zmc2V0Iiwib3ZlcnNjYW5GaXJzdCIsIm92ZXJzY2FuTGFzdCIsInZpc2libGUiLCJuZXdDZWxsQ291bnQiLCJtYXhOZXdDZWxscyIsImZpcnN0V2lsbEFkZE1vcmUiLCJmaXJzdFNob3VsZEluY3JlbWVudCIsImxhc3RXaWxsQWRkTW9yZSIsImxhc3RTaG91bGRJbmNyZW1lbnQiLCJFcnJvciIsIlZpcnR1YWxpemVVdGlscyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7QUFTQTs7OztBQUVBLElBQU1BLFlBQVlDLFFBQVEsb0JBQVIsQ0FBbEI7O0FBT0EsU0FBU0MsMEJBQVQsQ0FDRUMsT0FERixFQUVFQyxTQUZGLEVBR0VDLGVBSEYsRUFJaUI7QUFDZixN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LE9BQVAsR0FBaUJGLGVBQWpCIiwiZmlsZSI6IlZpcnR1YWxpemVVdGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqIEBmb3JtYXRcbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdmYmpzL2xpYi9pbnZhcmlhbnQnKTtcblxuLyoqXG4gKiBVc2VkIHRvIGZpbmQgdGhlIGluZGljZXMgb2YgdGhlIGZyYW1lcyB0aGF0IG92ZXJsYXAgdGhlIGdpdmVuIG9mZnNldHMuIFVzZWZ1bCBmb3IgZmluZGluZyB0aGVcbiAqIGl0ZW1zIHRoYXQgYm91bmQgZGlmZmVyZW50IHdpbmRvd3Mgb2YgY29udGVudCwgc3VjaCBhcyB0aGUgdmlzaWJsZSBhcmVhIG9yIHRoZSBidWZmZXJlZCBvdmVyc2NhblxuICogYXJlYS5cbiAqL1xuZnVuY3Rpb24gZWxlbWVudHNUaGF0T3ZlcmxhcE9mZnNldHMoXG4gIG9mZnNldHM6IEFycmF5PG51bWJlcj4sXG4gIGl0ZW1Db3VudDogbnVtYmVyLFxuICBnZXRGcmFtZU1ldHJpY3M6IChpbmRleDogbnVtYmVyKSA9PiB7bGVuZ3RoOiBudW1iZXIsIG9mZnNldDogbnVtYmVyfSxcbik6IEFycmF5PG51bWJlcj4ge1xuICBjb25zdCBvdXQgPSBbXTtcbiAgbGV0IG91dExlbmd0aCA9IDA7XG4gIGZvciAobGV0IGlpID0gMDsgaWkgPCBpdGVtQ291bnQ7IGlpKyspIHtcbiAgICBjb25zdCBmcmFtZSA9IGdldEZyYW1lTWV0cmljcyhpaSk7XG4gICAgY29uc3QgdHJhaWxpbmdPZmZzZXQgPSBmcmFtZS5vZmZzZXQgKyBmcmFtZS5sZW5ndGg7XG4gICAgZm9yIChsZXQga2sgPSAwOyBrayA8IG9mZnNldHMubGVuZ3RoOyBraysrKSB7XG4gICAgICBpZiAob3V0W2trXSA9PSBudWxsICYmIHRyYWlsaW5nT2Zmc2V0ID49IG9mZnNldHNba2tdKSB7XG4gICAgICAgIG91dFtra10gPSBpaTtcbiAgICAgICAgb3V0TGVuZ3RoKys7XG4gICAgICAgIGlmIChrayA9PT0gb2Zmc2V0cy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgaW52YXJpYW50KFxuICAgICAgICAgICAgb3V0TGVuZ3RoID09PSBvZmZzZXRzLmxlbmd0aCxcbiAgICAgICAgICAgICdiYWQgb2Zmc2V0cyBpbnB1dCwgc2hvdWxkIGJlIGluIGluY3JlYXNpbmcgb3JkZXI6ICVzJyxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KG9mZnNldHMpLFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIG91dDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gb3V0O1xufVxuXG4vKipcbiAqIENvbXB1dGVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIGBuZXh0YCByYW5nZSB0aGF0IGFyZSBuZXcgY29tcGFyZWQgdG8gdGhlIGBwcmV2YCByYW5nZS5cbiAqIEhhbmR5IGZvciBjYWxjdWxhdGluZyBob3cgbWFueSBuZXcgaXRlbXMgd2lsbCBiZSByZW5kZXJlZCB3aGVuIHRoZSByZW5kZXIgd2luZG93IGNoYW5nZXMgc28gd2VcbiAqIGNhbiByZXN0cmljdCB0aGUgbnVtYmVyIG9mIG5ldyBpdGVtcyByZW5kZXIgYXQgb25jZSBzbyB0aGF0IGNvbnRlbnQgY2FuIGFwcGVhciBvbiB0aGUgc2NyZWVuXG4gKiBmYXN0ZXIuXG4gKi9cbmZ1bmN0aW9uIG5ld1JhbmdlQ291bnQoXG4gIHByZXY6IHtmaXJzdDogbnVtYmVyLCBsYXN0OiBudW1iZXJ9LFxuICBuZXh0OiB7Zmlyc3Q6IG51bWJlciwgbGFzdDogbnVtYmVyfSxcbik6IG51bWJlciB7XG4gIHJldHVybiAoXG4gICAgbmV4dC5sYXN0IC1cbiAgICBuZXh0LmZpcnN0ICtcbiAgICAxIC1cbiAgICBNYXRoLm1heChcbiAgICAgIDAsXG4gICAgICAxICsgTWF0aC5taW4obmV4dC5sYXN0LCBwcmV2Lmxhc3QpIC0gTWF0aC5tYXgobmV4dC5maXJzdCwgcHJldi5maXJzdCksXG4gICAgKVxuICApO1xufVxuXG4vKipcbiAqIEN1c3RvbSBsb2dpYyBmb3IgZGV0ZXJtaW5pbmcgd2hpY2ggaXRlbXMgc2hvdWxkIGJlIHJlbmRlcmVkIGdpdmVuIHRoZSBjdXJyZW50IGZyYW1lIGFuZCBzY3JvbGxcbiAqIG1ldHJpY3MsIGFzIHdlbGwgYXMgdGhlIHByZXZpb3VzIHJlbmRlciBzdGF0ZS4gVGhlIGFsZ29yaXRobSBtYXkgZXZvbHZlIG92ZXIgdGltZSwgYnV0IGdlbmVyYWxseVxuICogcHJpb3JpdGl6ZXMgdGhlIHZpc2libGUgYXJlYSBmaXJzdCwgdGhlbiBleHBhbmRzIHRoYXQgd2l0aCBvdmVyc2NhbiByZWdpb25zIGFoZWFkIGFuZCBiZWhpbmQsXG4gKiBiaWFzZWQgaW4gdGhlIGRpcmVjdGlvbiBvZiBzY3JvbGwuXG4gKi9cbmZ1bmN0aW9uIGNvbXB1dGVXaW5kb3dlZFJlbmRlckxpbWl0cyhcbiAgcHJvcHM6IHtcbiAgICBkYXRhOiBhbnksXG4gICAgZ2V0SXRlbUNvdW50OiAoZGF0YTogYW55KSA9PiBudW1iZXIsXG4gICAgbWF4VG9SZW5kZXJQZXJCYXRjaDogbnVtYmVyLFxuICAgIHdpbmRvd1NpemU6IG51bWJlcixcbiAgfSxcbiAgcHJldjoge2ZpcnN0OiBudW1iZXIsIGxhc3Q6IG51bWJlcn0sXG4gIGdldEZyYW1lTWV0cmljc0FwcHJveDogKGluZGV4OiBudW1iZXIpID0+IHtsZW5ndGg6IG51bWJlciwgb2Zmc2V0OiBudW1iZXJ9LFxuICBzY3JvbGxNZXRyaWNzOiB7XG4gICAgZHQ6IG51bWJlcixcbiAgICBvZmZzZXQ6IG51bWJlcixcbiAgICB2ZWxvY2l0eTogbnVtYmVyLFxuICAgIHZpc2libGVMZW5ndGg6IG51bWJlcixcbiAgfSxcbik6IHtmaXJzdDogbnVtYmVyLCBsYXN0OiBudW1iZXJ9IHtcbiAgY29uc3Qge2RhdGEsIGdldEl0ZW1Db3VudCwgbWF4VG9SZW5kZXJQZXJCYXRjaCwgd2luZG93U2l6ZX0gPSBwcm9wcztcbiAgY29uc3QgaXRlbUNvdW50ID0gZ2V0SXRlbUNvdW50KGRhdGEpO1xuICBpZiAoaXRlbUNvdW50ID09PSAwKSB7XG4gICAgcmV0dXJuIHByZXY7XG4gIH1cbiAgY29uc3Qge29mZnNldCwgdmVsb2NpdHksIHZpc2libGVMZW5ndGh9ID0gc2Nyb2xsTWV0cmljcztcblxuICAvLyBTdGFydCB3aXRoIHZpc2libGUgYXJlYSwgdGhlbiBjb21wdXRlIG1heGltdW0gb3ZlcnNjYW4gcmVnaW9uIGJ5IGV4cGFuZGluZyBmcm9tIHRoZXJlLCBiaWFzZWRcbiAgLy8gaW4gdGhlIGRpcmVjdGlvbiBvZiBzY3JvbGwuIFRvdGFsIG92ZXJzY2FuIGFyZWEgaXMgY2FwcGVkLCB3aGljaCBzaG91bGQgY2FwIG1lbW9yeSBjb25zdW1wdGlvblxuICAvLyB0b28uXG4gIGNvbnN0IHZpc2libGVCZWdpbiA9IE1hdGgubWF4KDAsIG9mZnNldCk7XG4gIGNvbnN0IHZpc2libGVFbmQgPSB2aXNpYmxlQmVnaW4gKyB2aXNpYmxlTGVuZ3RoO1xuICBjb25zdCBvdmVyc2Nhbkxlbmd0aCA9ICh3aW5kb3dTaXplIC0gMSkgKiB2aXNpYmxlTGVuZ3RoO1xuXG4gIC8vIENvbnNpZGVyaW5nIHZlbG9jaXR5IHNlZW1zIHRvIGludHJvZHVjZSBtb3JlIGNodXJuIHRoYW4gaXQncyB3b3J0aC5cbiAgY29uc3QgbGVhZEZhY3RvciA9IDAuNTsgLy8gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdmVsb2NpdHkgLyAyNSArIDAuNSkpO1xuXG4gIGNvbnN0IGZpbGxQcmVmZXJlbmNlID1cbiAgICB2ZWxvY2l0eSA+IDEgPyAnYWZ0ZXInIDogdmVsb2NpdHkgPCAtMSA/ICdiZWZvcmUnIDogJ25vbmUnO1xuXG4gIGNvbnN0IG92ZXJzY2FuQmVnaW4gPSBNYXRoLm1heChcbiAgICAwLFxuICAgIHZpc2libGVCZWdpbiAtICgxIC0gbGVhZEZhY3RvcikgKiBvdmVyc2Nhbkxlbmd0aCxcbiAgKTtcbiAgY29uc3Qgb3ZlcnNjYW5FbmQgPSBNYXRoLm1heCgwLCB2aXNpYmxlRW5kICsgbGVhZEZhY3RvciAqIG92ZXJzY2FuTGVuZ3RoKTtcblxuICBjb25zdCBsYXN0SXRlbU9mZnNldCA9IGdldEZyYW1lTWV0cmljc0FwcHJveChpdGVtQ291bnQgLSAxKS5vZmZzZXQ7XG4gIGlmIChsYXN0SXRlbU9mZnNldCA8IG92ZXJzY2FuQmVnaW4pIHtcbiAgICAvLyBFbnRpcmUgbGlzdCBpcyBiZWZvcmUgb3VyIG92ZXJzY2FuIHdpbmRvd1xuICAgIHJldHVybiB7XG4gICAgICBmaXJzdDogTWF0aC5tYXgoMCwgaXRlbUNvdW50IC0gMSAtIG1heFRvUmVuZGVyUGVyQmF0Y2gpLFxuICAgICAgbGFzdDogaXRlbUNvdW50IC0gMSxcbiAgICB9O1xuICB9XG5cbiAgLy8gRmluZCB0aGUgaW5kaWNlcyB0aGF0IGNvcnJlc3BvbmQgdG8gdGhlIGl0ZW1zIGF0IHRoZSByZW5kZXIgYm91bmRhcmllcyB3ZSdyZSB0YXJnZXRpbmcuXG4gIGxldCBbb3ZlcnNjYW5GaXJzdCwgZmlyc3QsIGxhc3QsIG92ZXJzY2FuTGFzdF0gPSBlbGVtZW50c1RoYXRPdmVybGFwT2Zmc2V0cyhcbiAgICBbb3ZlcnNjYW5CZWdpbiwgdmlzaWJsZUJlZ2luLCB2aXNpYmxlRW5kLCBvdmVyc2NhbkVuZF0sXG4gICAgcHJvcHMuZ2V0SXRlbUNvdW50KHByb3BzLmRhdGEpLFxuICAgIGdldEZyYW1lTWV0cmljc0FwcHJveCxcbiAgKTtcbiAgb3ZlcnNjYW5GaXJzdCA9IG92ZXJzY2FuRmlyc3QgPT0gbnVsbCA/IDAgOiBvdmVyc2NhbkZpcnN0O1xuICBmaXJzdCA9IGZpcnN0ID09IG51bGwgPyBNYXRoLm1heCgwLCBvdmVyc2NhbkZpcnN0KSA6IGZpcnN0O1xuICBvdmVyc2Nhbkxhc3QgPSBvdmVyc2Nhbkxhc3QgPT0gbnVsbCA/IGl0ZW1Db3VudCAtIDEgOiBvdmVyc2Nhbkxhc3Q7XG4gIGxhc3QgPVxuICAgIGxhc3QgPT0gbnVsbFxuICAgICAgPyBNYXRoLm1pbihvdmVyc2Nhbkxhc3QsIGZpcnN0ICsgbWF4VG9SZW5kZXJQZXJCYXRjaCAtIDEpXG4gICAgICA6IGxhc3Q7XG4gIGNvbnN0IHZpc2libGUgPSB7Zmlyc3QsIGxhc3R9O1xuXG4gIC8vIFdlIHdhbnQgdG8gbGltaXQgdGhlIG51bWJlciBvZiBuZXcgY2VsbHMgd2UncmUgcmVuZGVyaW5nIHBlciBiYXRjaCBzbyB0aGF0IHdlIGNhbiBmaWxsIHRoZVxuICAvLyBjb250ZW50IG9uIHRoZSBzY3JlZW4gcXVpY2tseS4gSWYgd2UgcmVuZGVyZWQgdGhlIGVudGlyZSBvdmVyc2NhbiB3aW5kb3cgYXQgb25jZSwgdGhlIHVzZXJcbiAgLy8gY291bGQgYmUgc3RhcmluZyBhdCB3aGl0ZSBzcGFjZSBmb3IgYSBsb25nIHRpbWUgd2FpdGluZyBmb3IgYSBidW5jaCBvZiBvZmZzY3JlZW4gY29udGVudCB0b1xuICAvLyByZW5kZXIuXG4gIGxldCBuZXdDZWxsQ291bnQgPSBuZXdSYW5nZUNvdW50KHByZXYsIHZpc2libGUpO1xuXG4gIHdoaWxlICh0cnVlKSB7XG4gICAgaWYgKGZpcnN0IDw9IG92ZXJzY2FuRmlyc3QgJiYgbGFzdCA+PSBvdmVyc2Nhbkxhc3QpIHtcbiAgICAgIC8vIElmIHdlIGZpbGwgdGhlIGVudGlyZSBvdmVyc2NhbiByYW5nZSwgd2UncmUgZG9uZS5cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjb25zdCBtYXhOZXdDZWxscyA9IG5ld0NlbGxDb3VudCA+PSBtYXhUb1JlbmRlclBlckJhdGNoO1xuICAgIGNvbnN0IGZpcnN0V2lsbEFkZE1vcmUgPSBmaXJzdCA8PSBwcmV2LmZpcnN0IHx8IGZpcnN0ID4gcHJldi5sYXN0O1xuICAgIGNvbnN0IGZpcnN0U2hvdWxkSW5jcmVtZW50ID1cbiAgICAgIGZpcnN0ID4gb3ZlcnNjYW5GaXJzdCAmJiAoIW1heE5ld0NlbGxzIHx8ICFmaXJzdFdpbGxBZGRNb3JlKTtcbiAgICBjb25zdCBsYXN0V2lsbEFkZE1vcmUgPSBsYXN0ID49IHByZXYubGFzdCB8fCBsYXN0IDwgcHJldi5maXJzdDtcbiAgICBjb25zdCBsYXN0U2hvdWxkSW5jcmVtZW50ID1cbiAgICAgIGxhc3QgPCBvdmVyc2Nhbkxhc3QgJiYgKCFtYXhOZXdDZWxscyB8fCAhbGFzdFdpbGxBZGRNb3JlKTtcbiAgICBpZiAobWF4TmV3Q2VsbHMgJiYgIWZpcnN0U2hvdWxkSW5jcmVtZW50ICYmICFsYXN0U2hvdWxkSW5jcmVtZW50KSB7XG4gICAgICAvLyBXZSBvbmx5IHdhbnQgdG8gc3RvcCBpZiB3ZSd2ZSBoaXQgbWF4TmV3Q2VsbHMgQU5EIHdlIGNhbm5vdCBpbmNyZW1lbnQgZmlyc3Qgb3IgbGFzdFxuICAgICAgLy8gd2l0aG91dCByZW5kZXJpbmcgbmV3IGl0ZW1zLiBUaGlzIGxldCdzIHVzIHByZXNlcnZlIGFzIG1hbnkgYWxyZWFkeSByZW5kZXJlZCBpdGVtcyBhc1xuICAgICAgLy8gcG9zc2libGUsIHJlZHVjaW5nIHJlbmRlciBjaHVybiBhbmQga2VlcGluZyB0aGUgcmVuZGVyZWQgb3ZlcnNjYW4gcmFuZ2UgYXMgbGFyZ2UgYXNcbiAgICAgIC8vIHBvc3NpYmxlLlxuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGZpcnN0U2hvdWxkSW5jcmVtZW50ICYmXG4gICAgICAhKGZpbGxQcmVmZXJlbmNlID09PSAnYWZ0ZXInICYmIGxhc3RTaG91bGRJbmNyZW1lbnQgJiYgbGFzdFdpbGxBZGRNb3JlKVxuICAgICkge1xuICAgICAgaWYgKGZpcnN0V2lsbEFkZE1vcmUpIHtcbiAgICAgICAgbmV3Q2VsbENvdW50Kys7XG4gICAgICB9XG4gICAgICBmaXJzdC0tO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBsYXN0U2hvdWxkSW5jcmVtZW50ICYmXG4gICAgICAhKGZpbGxQcmVmZXJlbmNlID09PSAnYmVmb3JlJyAmJiBmaXJzdFNob3VsZEluY3JlbWVudCAmJiBmaXJzdFdpbGxBZGRNb3JlKVxuICAgICkge1xuICAgICAgaWYgKGxhc3RXaWxsQWRkTW9yZSkge1xuICAgICAgICBuZXdDZWxsQ291bnQrKztcbiAgICAgIH1cbiAgICAgIGxhc3QrKztcbiAgICB9XG4gIH1cbiAgaWYgKFxuICAgICEoXG4gICAgICBsYXN0ID49IGZpcnN0ICYmXG4gICAgICBmaXJzdCA+PSAwICYmXG4gICAgICBsYXN0IDwgaXRlbUNvdW50ICYmXG4gICAgICBmaXJzdCA+PSBvdmVyc2NhbkZpcnN0ICYmXG4gICAgICBsYXN0IDw9IG92ZXJzY2FuTGFzdCAmJlxuICAgICAgZmlyc3QgPD0gdmlzaWJsZS5maXJzdCAmJlxuICAgICAgbGFzdCA+PSB2aXNpYmxlLmxhc3RcbiAgICApXG4gICkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdCYWQgd2luZG93IGNhbGN1bGF0aW9uICcgK1xuICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZmlyc3QsXG4gICAgICAgICAgbGFzdCxcbiAgICAgICAgICBpdGVtQ291bnQsXG4gICAgICAgICAgb3ZlcnNjYW5GaXJzdCxcbiAgICAgICAgICBvdmVyc2Nhbkxhc3QsXG4gICAgICAgICAgdmlzaWJsZSxcbiAgICAgICAgfSksXG4gICAgKTtcbiAgfVxuICByZXR1cm4ge2ZpcnN0LCBsYXN0fTtcbn1cblxuY29uc3QgVmlydHVhbGl6ZVV0aWxzID0ge1xuICBjb21wdXRlV2luZG93ZWRSZW5kZXJMaW1pdHMsXG4gIGVsZW1lbnRzVGhhdE92ZXJsYXBPZmZzZXRzLFxuICBuZXdSYW5nZUNvdW50LFxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBWaXJ0dWFsaXplVXRpbHM7XG4iXX0=