21adf5ceb45ba2c80b93cb8c591aab76


'use strict';

var invariant = require('fbjs/lib/invariant');

var TRACE_TAG_REACT_APPS = 1 << 17;
var TRACE_TAG_JS_VM_CALLS = 1 << 27;

var _enabled = false;
var _asyncCookie = 0;
var _markStack = [];
var _markStackIndex = -1;
var _canInstallReactHook = false;

var REACT_MARKER = '\u269B';
var userTimingPolyfill = __DEV__ ? {
  mark: function mark(markName) {
    if (_enabled) {
      _markStackIndex++;
      _markStack[_markStackIndex] = markName;
      var systraceLabel = markName;

      if (markName[0] === REACT_MARKER) {
        var indexOfId = markName.lastIndexOf(' (#');
        var cutoffIndex = indexOfId !== -1 ? indexOfId : markName.length;

        systraceLabel = markName.slice(2, cutoffIndex);
      }
      Systrace.beginEvent(systraceLabel);
    }
  },
  measure: function measure(measureName, startMark, endMark) {
    if (_enabled) {
      invariant(typeof measureName === 'string' && typeof startMark === 'string' && typeof endMark === 'undefined', 'Only performance.measure(string, string) overload is supported.');
      var topMark = _markStack[_markStackIndex];
      invariant(startMark === topMark, 'There was a mismatching performance.measure() call. ' + 'Expected "%s" but got "%s."', topMark, startMark);
      _markStackIndex--;

      Systrace.endEvent();
    }
  },
  clearMarks: function clearMarks(markName) {
    if (_enabled) {
      if (_markStackIndex === -1) {
        return;
      }
      if (markName === _markStack[_markStackIndex]) {
        if (userTimingPolyfill != null) {
          userTimingPolyfill.measure(markName, markName);
        }
      }
    }
  },
  clearMeasures: function clearMeasures() {}
} : null;

var Systrace = {
  installReactHook: function installReactHook() {
    if (_enabled) {
      if (__DEV__) {
        global.performance = userTimingPolyfill;
      }
    }
    _canInstallReactHook = true;
  },
  setEnabled: function setEnabled(enabled) {
    if (_enabled !== enabled) {
      if (__DEV__) {
        if (enabled) {
          global.nativeTraceBeginLegacy && global.nativeTraceBeginLegacy(TRACE_TAG_JS_VM_CALLS);
        } else {
          global.nativeTraceEndLegacy && global.nativeTraceEndLegacy(TRACE_TAG_JS_VM_CALLS);
        }
        if (_canInstallReactHook) {
          if (enabled && global.performance === undefined) {
            global.performance = userTimingPolyfill;
          }
        }
      }
      _enabled = enabled;
    }
  },
  isEnabled: function isEnabled() {
    return _enabled;
  },
  beginEvent: function beginEvent(profileName, args) {
    if (_enabled) {
      profileName = typeof profileName === 'function' ? profileName() : profileName;
      global.nativeTraceBeginSection(TRACE_TAG_REACT_APPS, profileName, args);
    }
  },
  endEvent: function endEvent() {
    if (_enabled) {
      global.nativeTraceEndSection(TRACE_TAG_REACT_APPS);
    }
  },
  beginAsyncEvent: function beginAsyncEvent(profileName) {
    var cookie = _asyncCookie;
    if (_enabled) {
      _asyncCookie++;
      profileName = typeof profileName === 'function' ? profileName() : profileName;
      global.nativeTraceBeginAsyncSection(TRACE_TAG_REACT_APPS, profileName, cookie);
    }
    return cookie;
  },
  endAsyncEvent: function endAsyncEvent(profileName, cookie) {
    if (_enabled) {
      profileName = typeof profileName === 'function' ? profileName() : profileName;
      global.nativeTraceEndAsyncSection(TRACE_TAG_REACT_APPS, profileName, cookie);
    }
  },
  counterEvent: function counterEvent(profileName, value) {
    if (_enabled) {
      profileName = typeof profileName === 'function' ? profileName() : profileName;
      global.nativeTraceCounter && global.nativeTraceCounter(TRACE_TAG_REACT_APPS, profileName, value);
    }
  }
};

if (__DEV__) {
  require.Systrace = Systrace;
}

module.exports = Systrace;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlN5c3RyYWNlLmpzIl0sIm5hbWVzIjpbImludmFyaWFudCIsInJlcXVpcmUiLCJUUkFDRV9UQUdfUkVBQ1RfQVBQUyIsIlRSQUNFX1RBR19KU19WTV9DQUxMUyIsIl9lbmFibGVkIiwiX2FzeW5jQ29va2llIiwiX21hcmtTdGFjayIsIl9tYXJrU3RhY2tJbmRleCIsIl9jYW5JbnN0YWxsUmVhY3RIb29rIiwiUkVBQ1RfTUFSS0VSIiwidXNlclRpbWluZ1BvbHlmaWxsIiwiX19ERVZfXyIsIm1hcmsiLCJtYXJrTmFtZSIsInN5c3RyYWNlTGFiZWwiLCJpbmRleE9mSWQiLCJsYXN0SW5kZXhPZiIsImN1dG9mZkluZGV4IiwibGVuZ3RoIiwic2xpY2UiLCJTeXN0cmFjZSIsImJlZ2luRXZlbnQiLCJtZWFzdXJlIiwibWVhc3VyZU5hbWUiLCJzdGFydE1hcmsiLCJlbmRNYXJrIiwidG9wTWFyayIsImVuZEV2ZW50IiwiY2xlYXJNYXJrcyIsImNsZWFyTWVhc3VyZXMiLCJpbnN0YWxsUmVhY3RIb29rIiwiZ2xvYmFsIiwicGVyZm9ybWFuY2UiLCJzZXRFbmFibGVkIiwiZW5hYmxlZCIsIm5hdGl2ZVRyYWNlQmVnaW5MZWdhY3kiLCJuYXRpdmVUcmFjZUVuZExlZ2FjeSIsInVuZGVmaW5lZCIsImlzRW5hYmxlZCIsInByb2ZpbGVOYW1lIiwiYXJncyIsIm5hdGl2ZVRyYWNlQmVnaW5TZWN0aW9uIiwibmF0aXZlVHJhY2VFbmRTZWN0aW9uIiwiYmVnaW5Bc3luY0V2ZW50IiwiY29va2llIiwibmF0aXZlVHJhY2VCZWdpbkFzeW5jU2VjdGlvbiIsImVuZEFzeW5jRXZlbnQiLCJuYXRpdmVUcmFjZUVuZEFzeW5jU2VjdGlvbiIsImNvdW50ZXJFdmVudCIsInZhbHVlIiwibmF0aXZlVHJhY2VDb3VudGVyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFVQTs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLG9CQUFSLENBQWxCOztBQUVBLElBQU1DLHVCQUF1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UCxJQUNFbkIsT0FBT21CLGtCQUFQLENBQTBCaEQsb0JBQTFCLEVBQWdEcUMsV0FBaEQsRUFBNkRVLEtBQTdELENBREY7QUFFRDtBQUNGO0FBN0ZjLENBQWpCOztBQWdHQSxJQUFJdEMsT0FBSixFQUFhO0FBS1ZWLFNBQUQsQ0FBZW1CLFFBQWYsR0FBMEJBLFFBQTFCO0FBQ0Q7O0FBRUQrQixPQUFPQyxPQUFQLEdBQWlCaEMsUUFBakIiLCJmaWxlIjoiU3lzdHJhY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdmYmpzL2xpYi9pbnZhcmlhbnQnKTtcblxuY29uc3QgVFJBQ0VfVEFHX1JFQUNUX0FQUFMgPSAxIDw8IDE3OyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWJpdHdpc2VcbmNvbnN0IFRSQUNFX1RBR19KU19WTV9DQUxMUyA9IDEgPDwgMjc7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tYml0d2lzZVxuXG5sZXQgX2VuYWJsZWQgPSBmYWxzZTtcbmxldCBfYXN5bmNDb29raWUgPSAwO1xuY29uc3QgX21hcmtTdGFjayA9IFtdO1xubGV0IF9tYXJrU3RhY2tJbmRleCA9IC0xO1xubGV0IF9jYW5JbnN0YWxsUmVhY3RIb29rID0gZmFsc2U7XG5cbi8vIEltcGxlbWVudHMgYSBzdWJzZXQgb2YgVXNlciBUaW1pbmcgQVBJIG5lY2Vzc2FyeSBmb3IgUmVhY3QgbWVhc3VyZW1lbnRzLlxuLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1VzZXJfVGltaW5nX0FQSVxuY29uc3QgUkVBQ1RfTUFSS0VSID0gJ1xcdTI2OUInO1xuY29uc3QgdXNlclRpbWluZ1BvbHlmaWxsID0gX19ERVZfX1xuICA/IHtcbiAgICAgIG1hcmsobWFya05hbWU6IHN0cmluZykge1xuICAgICAgICBpZiAoX2VuYWJsZWQpIHtcbiAgICAgICAgICBfbWFya1N0YWNrSW5kZXgrKztcbiAgICAgICAgICBfbWFya1N0YWNrW19tYXJrU3RhY2tJbmRleF0gPSBtYXJrTmFtZTtcbiAgICAgICAgICBsZXQgc3lzdHJhY2VMYWJlbCA9IG1hcmtOYW1lO1xuICAgICAgICAgIC8vIFNpbmNlIHBlcmYgbWVhc3VyZW1lbnRzIGFyZSBhIHNoYXJlZCBuYW1lc3BhY2UgaW4gVXNlciBUaW1pbmcgQVBJLFxuICAgICAgICAgIC8vIHdlIHByZWZpeCBhbGwgUmVhY3QgcmVzdWx0cyB3aXRoIGEgUmVhY3QgZW1vamkuXG4gICAgICAgICAgaWYgKG1hcmtOYW1lWzBdID09PSBSRUFDVF9NQVJLRVIpIHtcbiAgICAgICAgICAgIC8vIFRoaXMgaXMgY29taW5nIGZyb20gUmVhY3QuXG4gICAgICAgICAgICAvLyBSZW1vdmluZyBjb21wb25lbnQgSURzIGtlZXBzIHRyYWNlIGNvbG9ycyBzdGFibGUuXG4gICAgICAgICAgICBjb25zdCBpbmRleE9mSWQgPSBtYXJrTmFtZS5sYXN0SW5kZXhPZignICgjJyk7XG4gICAgICAgICAgICBjb25zdCBjdXRvZmZJbmRleCA9IGluZGV4T2ZJZCAhPT0gLTEgPyBpbmRleE9mSWQgOiBtYXJrTmFtZS5sZW5ndGg7XG4gICAgICAgICAgICAvLyBBbHNvIGN1dCBvZmYgdGhlIGVtb2ppIGJlY2F1c2UgaXQgYnJlYWtzIFN5c3RyYWNlXG4gICAgICAgICAgICBzeXN0cmFjZUxhYmVsID0gbWFya05hbWUuc2xpY2UoMiwgY3V0b2ZmSW5kZXgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBTeXN0cmFjZS5iZWdpbkV2ZW50KHN5c3RyYWNlTGFiZWwpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgbWVhc3VyZShtZWFzdXJlTmFtZTogc3RyaW5nLCBzdGFydE1hcms6ID9zdHJpbmcsIGVuZE1hcms6ID9zdHJpbmcpIHtcbiAgICAgICAgaWYgKF9lbmFibGVkKSB7XG4gICAgICAgICAgaW52YXJpYW50KFxuICAgICAgICAgICAgdHlwZW9mIG1lYXN1cmVOYW1lID09PSAnc3RyaW5nJyAmJlxuICAgICAgICAgICAgICB0eXBlb2Ygc3RhcnRNYXJrID09PSAnc3RyaW5nJyAmJlxuICAgICAgICAgICAgICB0eXBlb2YgZW5kTWFyayA9PT0gJ3VuZGVmaW5lZCcsXG4gICAgICAgICAgICAnT25seSBwZXJmb3JtYW5jZS5tZWFzdXJlKHN0cmluZywgc3RyaW5nKSBvdmVybG9hZCBpcyBzdXBwb3J0ZWQuJyxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IHRvcE1hcmsgPSBfbWFya1N0YWNrW19tYXJrU3RhY2tJbmRleF07XG4gICAgICAgICAgaW52YXJpYW50KFxuICAgICAgICAgICAgc3RhcnRNYXJrID09PSB0b3BNYXJrLFxuICAgICAgICAgICAgJ1RoZXJlIHdhcyBhIG1pc21hdGNoaW5nIHBlcmZvcm1hbmNlLm1lYXN1cmUoKSBjYWxsLiAnICtcbiAgICAgICAgICAgICAgJ0V4cGVjdGVkIFwiJXNcIiBidXQgZ290IFwiJXMuXCInLFxuICAgICAgICAgICAgdG9wTWFyayxcbiAgICAgICAgICAgIHN0YXJ0TWFyayxcbiAgICAgICAgICApO1xuICAgICAgICAgIF9tYXJrU3RhY2tJbmRleC0tO1xuICAgICAgICAgIC8vIFdlIGNhbid0IHVzZSBtb3JlIGRlc2NyaXB0aXZlIG1lYXN1cmVOYW1lIGJlY2F1c2UgU3lzdHJhY2UgZG9lc24ndFxuICAgICAgICAgIC8vIGxldCB1cyBlZGl0IGxhYmVscyBwb3N0IGZhY3R1bS5cbiAgICAgICAgICBTeXN0cmFjZS5lbmRFdmVudCgpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgY2xlYXJNYXJrcyhtYXJrTmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChfZW5hYmxlZCkge1xuICAgICAgICAgIGlmIChfbWFya1N0YWNrSW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChtYXJrTmFtZSA9PT0gX21hcmtTdGFja1tfbWFya1N0YWNrSW5kZXhdKSB7XG4gICAgICAgICAgICAvLyBSZWFjdCB1c2VzIHRoaXMgZm9yIFwiY2FuY2VsbGluZ1wiIHN0YXJ0ZWQgbWVhc3VyZW1lbnRzLlxuICAgICAgICAgICAgLy8gU3lzdHJhY2UgZG9lc24ndCBzdXBwb3J0IGRlbGV0aW5nIG1lYXN1cmVtZW50cywgc28gd2UganVzdCBzdG9wIHRoZW0uXG4gICAgICAgICAgICBpZiAodXNlclRpbWluZ1BvbHlmaWxsICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgdXNlclRpbWluZ1BvbHlmaWxsLm1lYXN1cmUobWFya05hbWUsIG1hcmtOYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBjbGVhck1lYXN1cmVzKCkge1xuICAgICAgICAvLyBSZWFjdCBjYWxscyB0aGlzIHRvIGF2b2lkIG1lbW9yeSBsZWFrcyBpbiBicm93c2VycywgYnV0IHdlIGRvbid0IGtlZXBcbiAgICAgICAgLy8gbWVhc3VyZW1lbnRzIGFueXdheS5cbiAgICAgIH0sXG4gICAgfVxuICA6IG51bGw7XG5cbmNvbnN0IFN5c3RyYWNlID0ge1xuICBpbnN0YWxsUmVhY3RIb29rKCkge1xuICAgIGlmIChfZW5hYmxlZCkge1xuICAgICAgaWYgKF9fREVWX18pIHtcbiAgICAgICAgZ2xvYmFsLnBlcmZvcm1hbmNlID0gdXNlclRpbWluZ1BvbHlmaWxsO1xuICAgICAgfVxuICAgIH1cbiAgICBfY2FuSW5zdGFsbFJlYWN0SG9vayA9IHRydWU7XG4gIH0sXG5cbiAgc2V0RW5hYmxlZChlbmFibGVkOiBib29sZWFuKSB7XG4gICAgaWYgKF9lbmFibGVkICE9PSBlbmFibGVkKSB7XG4gICAgICBpZiAoX19ERVZfXykge1xuICAgICAgICBpZiAoZW5hYmxlZCkge1xuICAgICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUJlZ2luTGVnYWN5ICYmXG4gICAgICAgICAgICBnbG9iYWwubmF0aXZlVHJhY2VCZWdpbkxlZ2FjeShUUkFDRV9UQUdfSlNfVk1fQ0FMTFMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUVuZExlZ2FjeSAmJlxuICAgICAgICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlRW5kTGVnYWN5KFRSQUNFX1RBR19KU19WTV9DQUxMUyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF9jYW5JbnN0YWxsUmVhY3RIb29rKSB7XG4gICAgICAgICAgaWYgKGVuYWJsZWQgJiYgZ2xvYmFsLnBlcmZvcm1hbmNlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGdsb2JhbC5wZXJmb3JtYW5jZSA9IHVzZXJUaW1pbmdQb2x5ZmlsbDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIF9lbmFibGVkID0gZW5hYmxlZDtcbiAgICB9XG4gIH0sXG5cbiAgaXNFbmFibGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBfZW5hYmxlZDtcbiAgfSxcblxuICAvKipcbiAgICogYmVnaW5FdmVudC9lbmRFdmVudCBmb3Igc3RhcnRpbmcgYW5kIHRoZW4gZW5kaW5nIGEgcHJvZmlsZSB3aXRoaW4gdGhlIHNhbWUgY2FsbCBzdGFjayBmcmFtZVxuICAgKiovXG4gIGJlZ2luRXZlbnQocHJvZmlsZU5hbWU/OiBhbnksIGFyZ3M/OiBhbnkpIHtcbiAgICBpZiAoX2VuYWJsZWQpIHtcbiAgICAgIHByb2ZpbGVOYW1lID1cbiAgICAgICAgdHlwZW9mIHByb2ZpbGVOYW1lID09PSAnZnVuY3Rpb24nID8gcHJvZmlsZU5hbWUoKSA6IHByb2ZpbGVOYW1lO1xuICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlQmVnaW5TZWN0aW9uKFRSQUNFX1RBR19SRUFDVF9BUFBTLCBwcm9maWxlTmFtZSwgYXJncyk7XG4gICAgfVxuICB9LFxuXG4gIGVuZEV2ZW50KCkge1xuICAgIGlmIChfZW5hYmxlZCkge1xuICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlRW5kU2VjdGlvbihUUkFDRV9UQUdfUkVBQ1RfQVBQUyk7XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiBiZWdpbkFzeW5jRXZlbnQvZW5kQXN5bmNFdmVudCBmb3Igc3RhcnRpbmcgYW5kIHRoZW4gZW5kaW5nIGEgcHJvZmlsZSB3aGVyZSB0aGUgZW5kIGNhbiBlaXRoZXJcbiAgICogb2NjdXIgb24gYW5vdGhlciB0aHJlYWQgb3Igb3V0IG9mIHRoZSBjdXJyZW50IHN0YWNrIGZyYW1lLCBlZyBhd2FpdFxuICAgKiB0aGUgcmV0dXJuZWQgY29va2llIHZhcmlhYmxlIHNob3VsZCBiZSB1c2VkIGFzIGlucHV0IGludG8gdGhlIGVuZEFzeW5jRXZlbnQgY2FsbCB0byBlbmQgdGhlIHByb2ZpbGVcbiAgICoqL1xuICBiZWdpbkFzeW5jRXZlbnQocHJvZmlsZU5hbWU/OiBhbnkpOiBhbnkge1xuICAgIGNvbnN0IGNvb2tpZSA9IF9hc3luY0Nvb2tpZTtcbiAgICBpZiAoX2VuYWJsZWQpIHtcbiAgICAgIF9hc3luY0Nvb2tpZSsrO1xuICAgICAgcHJvZmlsZU5hbWUgPVxuICAgICAgICB0eXBlb2YgcHJvZmlsZU5hbWUgPT09ICdmdW5jdGlvbicgPyBwcm9maWxlTmFtZSgpIDogcHJvZmlsZU5hbWU7XG4gICAgICBnbG9iYWwubmF0aXZlVHJhY2VCZWdpbkFzeW5jU2VjdGlvbihcbiAgICAgICAgVFJBQ0VfVEFHX1JFQUNUX0FQUFMsXG4gICAgICAgIHByb2ZpbGVOYW1lLFxuICAgICAgICBjb29raWUsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gY29va2llO1xuICB9LFxuXG4gIGVuZEFzeW5jRXZlbnQocHJvZmlsZU5hbWU/OiBhbnksIGNvb2tpZT86IGFueSkge1xuICAgIGlmIChfZW5hYmxlZCkge1xuICAgICAgcHJvZmlsZU5hbWUgPVxuICAgICAgICB0eXBlb2YgcHJvZmlsZU5hbWUgPT09ICdmdW5jdGlvbicgPyBwcm9maWxlTmFtZSgpIDogcHJvZmlsZU5hbWU7XG4gICAgICBnbG9iYWwubmF0aXZlVHJhY2VFbmRBc3luY1NlY3Rpb24oXG4gICAgICAgIFRSQUNFX1RBR19SRUFDVF9BUFBTLFxuICAgICAgICBwcm9maWxlTmFtZSxcbiAgICAgICAgY29va2llLFxuICAgICAgKTtcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIGNvdW50ZXJFdmVudCByZWdpc3RlcnMgdGhlIHZhbHVlIHRvIHRoZSBwcm9maWxlTmFtZSBvbiB0aGUgc3lzdHJhY2UgdGltZWxpbmVcbiAgICoqL1xuICBjb3VudGVyRXZlbnQocHJvZmlsZU5hbWU/OiBhbnksIHZhbHVlPzogYW55KSB7XG4gICAgaWYgKF9lbmFibGVkKSB7XG4gICAgICBwcm9maWxlTmFtZSA9XG4gICAgICAgIHR5cGVvZiBwcm9maWxlTmFtZSA9PT0gJ2Z1bmN0aW9uJyA/IHByb2ZpbGVOYW1lKCkgOiBwcm9maWxlTmFtZTtcbiAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUNvdW50ZXIgJiZcbiAgICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlQ291bnRlcihUUkFDRV9UQUdfUkVBQ1RfQVBQUywgcHJvZmlsZU5hbWUsIHZhbHVlKTtcbiAgICB9XG4gIH0sXG59O1xuXG5pZiAoX19ERVZfXykge1xuICAvLyBUaGlzIGlzIG5lZWRlZCwgYmVjYXVzZSByZXF1aXJlIGNhbGxpcyBpbiBwb2x5ZmlsbHMgYXJlIG5vdCBwcm9jZXNzZWQgYXNcbiAgLy8gb3RoZXIgZmlsZXMuIFRoZXJlZm9yZSwgY2FsbHMgdG8gYHJlcXVpcmUoJ21vZHVsZUlkJylgIGFyZSBub3QgcmVwbGFjZWRcbiAgLy8gd2l0aCBudW1lcmljIElEc1xuICAvLyBUT0RPKGRhdmlkYXVyZWxpbykgU2NhbiBwb2x5ZmlsbHMgZm9yIGRlcGVuZGVuY2llcywgdG9vICh0OTc1OTY4NilcbiAgKHJlcXVpcmU6IGFueSkuU3lzdHJhY2UgPSBTeXN0cmFjZTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBTeXN0cmFjZTtcbiJdfQ==